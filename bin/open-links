#!/usr/local/bin/lispscript

; vi: ft=lisp



(defparameter *chrome-app*    •"/Applications/Google Chrome.app"•)
(defparameter *chrome-bin*    •"/Applications/Google Chrome.app/Contents/MacOS/Google Chrome"•)
(defparameter *firefox-app*   •/Applications/Firefox.app•)
(defparameter *firefox-bin*   •/Applications/Firefox.app/Contents/MacOS/firefox•)

(defparams *firefox-p*  *chrome-p*    *theinput*
           *dry-p*      *thebrowser*  *tmp*)


(def-cli-args "open-links" "open-links -hd -[fc]"
  "open list of urls in a browser at once"

  (option "-h" "--help" "print usage"
          (print-usage!))

  (option "-c" "--chrome" "use chrome"
          (if *firefox-p* (error "you can only use one browser")
            (setq *chrome-p* t))
          (process-args! (cdr args!)))

  (option "-f" "--firefox" "use firefox"
          (if *chrome-p* (error "you can only use one browser")
            (setq *firefox-p* t))
          (process-args! (cdr args!)))

  (option "-d" "--dry-run" "dry run"
          (setq *dry-p* t)
          (process-args! (cdr args!))))



(process-args! (cdr (cmdargs)))


« (defparameter *theinput* Ø (car bare-args!))
    or die "An input source was not specified" »


(setq *theinput* (if-this->then *theinput* #'string= *theinput*
                                "-" -> *standard-input*))


; (debug-these *theinput* *firefox-p* *chrome-p*)

; (die-if-null *theinput* *firefox-p*) ;*chrome-p*)
; (die-if-null *theinput* *firefox-p* *chrome-p*)


; (die "")

(defun do-chrome ()
  ; (zsh (format nil "open ~A --args --incognito" *chrome-app*)
  (zsh (format nil "open ~A" *chrome-app*)
       :dry-run *dry-p*)
  (sleep 1)
  (for-each *theinput*
    (when (or (~m value! "^#") (~m value! "^\s*$")) (continue!))
    (zsh (format nil •~A "~A"• *chrome-bin* value!) :dry-run *dry-p*)))


(defun do-firefox ()
  (let* ((url-list      (str-split (slurp *theinput*) •\n•))
         (url-string    (format nil •~{"~A" ~}• url-list))
         (fire-command  (format nil "open -a ~A ~A" *firefox-app* url-string)))
    (zsh fire-command :dry-run *dry-p*)))


(if->then
  *firefox-p*     -> (do-firefox)
  *chrome-p*      -> (do-chrome))




; vi: ft=lisp
